{
  "run_mode": "teacher_free",
  "teacher_type": "none",
  "student_attn_impl": "wda",
  "teacher_model_id": "HuggingFaceTB/SmolLM-135M",
  "teacher_free_mode": true,
  "final_force_teacher_off": true,

  "device": "cuda",
  "torch_dtype": "bfloat16",
  "out_dir": "private/checkpoints/smol135m_wda_teacherfree_sft_phase3",

  "datasets": [
    {
      "kind": "hf_chat",
      "dataset_name": "HuggingFaceH4/ultrachat_200k",
      "split": "train_sft",
      "assistant_only_loss": true,
      "include_assistant_prefix_in_loss": false,
      "ratio": 0.9
    },
    {
      "kind": "local_jsonl",
      "path": "private/data/smol135m_chunk_v2/python_edu.jsonl",
      "text_column": "text",
      "ratio": 0.1
    }
  ],

  "seq_len": 1024,
  "micro_batch_size": 4,
  "grad_accum": 2,
  "steps": 999999,
  "run_steps": 1000,

  "lr": 5e-4,
  "gamma_only_lr": 0.0015,
  "weight_decay": 0.0,
  "warmup_steps": 20,
  "max_grad_norm": 1.0,

  "temperature": 1.0,
  "kl_weight": 0.0,
  "ce_weight": 1.0,
  "alpha_warmup_steps": 0,
  "hidden_match_weight": 0.0,
  "autopilot_enabled": false,
  "loss_chunk_size": 512,

  "save_every": 50,
  "log_every": 2,
  "baseline_pct_log_topk": 5,

  "train_gamma_only": false,
  "init_gamma": 0.05,
  "gamma_l1_weight": 0.0,
  "distill": {
    "enabled": false,
    "targets": ["resid_energy"],
    "mse_weight": 0.0,
    "cosine_weight": 0.0,
    "layer_weights": "depth_decay"
  },

  "teacher_free_alpha": 1.0,
  "teacher_free_teacher_scale": 0.0,
  "teacher_free_wda_scale": 1.0,
  "teacher_free_gamma_reset": false,

  "schedule": {
    "stages": [
      {
        "name": "burst_0",
        "start_step": 0,
        "steps": 100,
        "alpha": 1.0,
        "teacher_scale": 0.0,
        "wda_scale": 1.0,
        "gate_temp": 0.1,
        "lr_scale": 2.0
      },
      {
        "name": "cruise_0",
        "start_step": 100,
        "steps": 400,
        "alpha": 1.0,
        "teacher_scale": 0.0,
        "wda_scale": 1.0,
        "gate_temp": 0.1,
        "lr_scale": 1.0
      },
      {
        "name": "burst_1",
        "start_step": 500,
        "steps": 100,
        "alpha": 1.0,
        "teacher_scale": 0.0,
        "wda_scale": 1.0,
        "gate_temp": 0.1,
        "lr_scale": 1.5
      },
      {
        "name": "cruise_1",
        "start_step": 600,
        "steps": 400,
        "alpha": 1.0,
        "teacher_scale": 0.0,
        "wda_scale": 1.0,
        "gate_temp": 0.1,
        "lr_scale": 1.0
      }
    ]
  },
  "teacher_scale_start": 0.0,
  "teacher_scale_end": 0.0,
  "wda_scale_start": 1.0,
  "wda_scale_end": 1.0,
  "handoff_start_step": 0,
  "handoff_steps": 0,
  
  "gamma_floor_start": 0.025,
  "gamma_floor_end": 0.025,
  "gamma_floor_start_step": 0,
  "gamma_floor_steps": 0,

  "wda_num_masks": 128,
  "wda_num_waves_per_mask": 32,
  "wda_topk_masks": 4,
  "wda_gate_temp": 0.2,
  "wda_attn_alpha": 3.0,
  "wda_use_sin_waves": true,
  "wda_gain_min": 1.0,
  "wda_gain_max": 10.0,
  "wda_gain_l2_weight": 0.0,
  "wda_gain_target": 1.0,
  "routing_entropy_weight": 0.0,

  "eval": {
    "enabled": false,
    "every": 200,
    "batches": 2,
    "teacher_free": true,
    "max_new_tokens": 200,
    "temperature": 0.7,
    "top_p": 0.9,
    "prompts": [
      "Explain why the sky is blue in two sentences."
    ]
  }
}
